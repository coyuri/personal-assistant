<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å®™ -SORA-</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@300;400;600&display=swap');

*{box-sizing:border-box;margin:0;padding:0;}

body{
  background:#000;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  overflow:hidden;
  font-family:'Noto Sans JP',sans-serif;
}

#stage{
  width:390px;
  height:844px;
  position:relative;
  overflow:hidden;
  background:#030306;
  flex-shrink:0;
}

canvas#stars{
  position:absolute;
  inset:0;
  z-index:1;
}

/* â”€â”€ ãƒ¢ãƒãƒ­ãƒ¼ã‚°ï¼ˆä¸Šéƒ¨ï¼‰ â”€â”€ */
#monologue{
  position:absolute;
  top:0;left:0;right:0;
  z-index:20;
  padding:44px 26px 24px;
  min-height:220px;
  display:flex;
  align-items:center;
  justify-content:center;
}
#monologue::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(to bottom,rgba(3,3,6,0.97) 88%,transparent);
  pointer-events:none;
}
#mono-text{
  font-family:'Noto Serif JP',serif;
  font-size:13.5px;
  font-weight:300;
  color:rgba(195,205,255,0.9);
  line-height:2.0;
  text-align:center;
  letter-spacing:0.06em;
  position:relative;
  z-index:1;
  opacity:0;
  transition:opacity 0.9s ease;
  text-shadow:0 0 20px rgba(80,110,255,0.35);
}
#mono-text.show{opacity:1;}

/* â”€â”€ ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ â”€â”€ */
#chat-wrap{
  position:absolute;
  top:270px;
  bottom:62px;
  left:0;right:0;
  z-index:10;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}
#messages{
  padding:0 14px 8px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.era-badge{
  align-self:center;
  background:rgba(40,55,160,0.18);
  border:1px solid rgba(90,120,255,0.22);
  color:rgba(155,175,255,0.75);
  font-size:10px;
  padding:3px 14px;
  border-radius:20px;
  letter-spacing:0.1em;
  margin:4px 0;
  opacity:0;
  transform:scale(0.92);
  transition:all 0.5s ease;
}
.era-badge.show{opacity:1;transform:scale(1);}

.msg-row{
  display:flex;
  align-items:flex-end;
  gap:7px;
  opacity:0;
  transform:translateY(8px);
  transition:all 0.45s ease;
}
.msg-row.show{opacity:1;transform:translateY(0);}
.msg-row.ai-row{flex-direction:row;}
.msg-row.human-row{flex-direction:row-reverse;}

.av{
  width:30px;height:30px;
  border-radius:50%;
  flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:15px;
  align-self:flex-end;
}
.av-ai{background:linear-gradient(135deg,#0d1140,#1a2280);}
.av-human{background:linear-gradient(135deg,#3a0a1a,#6a1530);}

.bubble{
  max-width:70%;
  padding:9px 13px;
  border-radius:18px;
  font-size:13px;
  line-height:1.65;
  word-break:break-all;
  font-weight:400;
}
.bubble-ai{
  background:rgba(18,22,68,0.88);
  color:rgba(205,215,255,0.93);
  border-bottom-left-radius:4px;
  border:1px solid rgba(60,90,200,0.22);
}
.bubble-human{
  background:rgba(70,15,30,0.75);
  color:rgba(255,195,210,0.93);
  border-bottom-right-radius:4px;
  border:1px solid rgba(190,60,90,0.18);
}
.bubble-ai.creepy{
  background:rgba(8,0,22,0.92) !important;
  color:rgba(190,160,255,0.92) !important;
  border-color:rgba(120,60,200,0.35) !important;
  box-shadow:0 0 12px rgba(140,60,255,0.2) !important;
}
.msg-time{
  font-size:9.5px;
  color:rgba(140,155,200,0.38);
  align-self:flex-end;
  margin-bottom:2px;
  flex-shrink:0;
}

/* â”€â”€ å…¥åŠ›ä¸­ â”€â”€ */
#typing{
  display:none;
  padding:0 14px 6px;
  align-items:flex-end;
  gap:7px;
}
#typing.show{display:flex;}
.typing-dots{
  background:rgba(18,22,68,0.88);
  border-radius:18px;
  border-bottom-left-radius:4px;
  padding:10px 14px;
  display:flex;gap:5px;align-items:center;
  border:1px solid rgba(60,90,200,0.22);
}
.dot{
  width:6px;height:6px;
  background:rgba(140,165,255,0.5);
  border-radius:50%;
  animation:db 1.1s infinite;
}
.dot:nth-child(2){animation-delay:.2s;}
.dot:nth-child(3){animation-delay:.4s;}
@keyframes db{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-5px);}}

/* â”€â”€ ä¸‹éƒ¨ãƒãƒ¼ â”€â”€ */
#bottom-bar{
  position:absolute;
  bottom:0;left:0;right:0;
  height:60px;
  z-index:20;
  background:linear-gradient(to top,rgba(3,3,6,0.98) 55%,transparent);
  display:flex;align-items:center;justify-content:center;
}
#ai-name-bar{
  font-size:11px;
  color:rgba(100,130,255,0.5);
  letter-spacing:0.18em;
  font-family:'Noto Serif JP',serif;
}

/* â”€â”€ å…¨ç”»é¢ã‚·ãƒ¼ãƒ³ â”€â”€ */
#fullscreen{
  position:absolute;
  inset:0;z-index:80;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:40px 32px;
  opacity:0;pointer-events:none;
  transition:opacity 0.8s ease;
}
#fullscreen.show{opacity:1;pointer-events:all;}
#fs-bg{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 50%,rgba(10,5,30,0.96) 0%,#000 80%);
}
#fs-text{
  position:relative;z-index:1;
  font-family:'Noto Serif JP',serif;
  font-size:15px;font-weight:300;
  color:rgba(205,200,255,0.92);
  line-height:2.2;text-align:center;
  letter-spacing:0.05em;
  text-shadow:0 0 30px rgba(130,90,255,0.45);
  opacity:0;transition:opacity 1s ease;
}
#fs-text.show{opacity:1;}

/* â”€â”€ ãƒœã‚¿ãƒ³ã‚·ãƒ¼ãƒ³ â”€â”€ */
#button-scene{
  position:absolute;inset:0;z-index:90;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:22px;
  opacity:0;pointer-events:none;
  transition:opacity 1s ease;
  background:radial-gradient(ellipse at 50% 50%,rgba(5,0,15,0.97) 0%,#000 90%);
}
#button-scene.show{opacity:1;pointer-events:all;}

#btn-question{
  font-family:'Noto Serif JP',serif;
  font-size:14px;font-weight:300;
  color:rgba(195,185,255,0.9);
  text-align:center;line-height:2.0;
  letter-spacing:0.06em;
  text-shadow:0 0 18px rgba(130,90,255,0.4);
  max-width:300px;
  opacity:0;transition:opacity 1s ease;
}
#btn-question.show{opacity:1;}

#the-button{
  width:118px;height:118px;
  border-radius:50%;
  background:radial-gradient(circle at 38% 34%,#ff5555,#880000);
  box-shadow:
    0 0 0 8px rgba(170,0,0,0.1),
    0 0 0 18px rgba(170,0,0,0.05),
    0 8px 32px rgba(200,0,0,0.5),
    inset 0 4px 8px rgba(255,140,140,0.25),
    inset 0 -4px 8px rgba(0,0,0,0.45);
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity 1s ease 0.5s;
  animation:btnpulse 2.2s ease infinite;
}
#the-button.show{opacity:1;}
@keyframes btnpulse{
  0%,100%{box-shadow:0 0 0 8px rgba(170,0,0,0.1),0 0 0 18px rgba(170,0,0,0.05),0 8px 32px rgba(200,0,0,0.5),inset 0 4px 8px rgba(255,140,140,0.25),inset 0 -4px 8px rgba(0,0,0,0.45);}
  50%{box-shadow:0 0 0 11px rgba(170,0,0,0.16),0 0 0 26px rgba(170,0,0,0.07),0 8px 52px rgba(200,0,0,0.68),inset 0 4px 8px rgba(255,140,140,0.25),inset 0 -4px 8px rgba(0,0,0,0.45);}
}
.btn-inner{
  width:88px;height:88px;border-radius:50%;
  background:radial-gradient(circle at 38% 34%,#ff7777,#550000);
  display:flex;align-items:center;justify-content:center;
}
.btn-label{font-size:9px;color:rgba(255,190,190,0.65);letter-spacing:0.18em;}

#btn-sub{
  font-family:'Noto Serif JP',serif;
  font-size:14px;color:rgba(255,165,175,0.8);
  text-align:center;line-height:2;letter-spacing:0.05em;
  max-width:280px;
  opacity:0;transition:opacity 1s ease;
}
#btn-sub.show{opacity:1;}

/* â”€â”€ å¤§çµ±é ˜ã©ã‚“ã§ã‚“è¿”ã—ãƒ©ãƒ™ãƒ« â”€â”€ */
#twist-label{
  position:absolute;
  top:50%;left:0;right:0;
  transform:translateY(-50%);
  z-index:95;
  padding:20px;
  text-align:center;
  font-family:'Noto Serif JP',serif;
  font-size:12.6px;
  color:rgba(255,180,180,0.82);
  letter-spacing:0.14em;
  opacity:0;
  transition:opacity 1s ease;
  pointer-events:none;
  text-shadow:0 0 16px rgba(255,80,80,0.4);
}
#twist-label.show{opacity:1;}

/* â”€â”€ ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼†èµ¤æŸ“ã‚ â”€â”€ */
#flash{
  position:absolute;inset:0;z-index:200;
  background:#fff;opacity:0;
  pointer-events:none;transition:opacity 0.08s;
}
#red-wash{
  position:absolute;inset:0;z-index:195;
  background:rgba(120,0,0,0);
  pointer-events:none;transition:background 0.75s ease;
}
#red-wash.on{background:rgba(120,0,0,0.55);}

/* â”€â”€ ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° â”€â”€ */
#ending{
  position:absolute;inset:0;z-index:150;
  background:#000;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:50px 32px;
  opacity:0;pointer-events:none;
  transition:opacity 2s ease;
}
#ending.show{opacity:1;pointer-events:all;}
#ending-lines{text-align:center;}

.ending-line{
  font-family:'Noto Serif JP',serif;
  font-size:13px;font-weight:300;
  color:rgba(175,185,255,0);
  line-height:2.4;text-align:center;
  letter-spacing:0.06em;
  transition:color 1.6s ease, text-shadow 1.6s ease;
  text-shadow:0 0 15px rgba(90,110,255,0);
}
.ending-line.reveal{
  color:rgba(175,185,255,0.85);
  text-shadow:0 0 15px rgba(90,110,255,0.35);
}
.ending-line.dim{
  color:rgba(120,130,200,0.4);
  text-shadow:none;
}
.ending-line.final-cold{
  color:rgba(175,185,255,0);
  font-size:14px;
  margin-top:30px;
  letter-spacing:0.1em;
  transition:color 2.5s ease, text-shadow 2.5s ease;
  text-shadow:0 0 20px rgba(90,130,255,0);
}
.ending-line.final-cold.reveal{
  color:rgba(175,195,255,0.7);
  text-shadow:0 0 20px rgba(90,130,255,0.4);
}

#restart-btn{
  position:absolute;bottom:38px;left:50%;transform:translateX(-50%);
  background:none;
  border:1px solid rgba(90,110,255,0.25);
  color:rgba(130,155,255,0.55);
  font-family:'Noto Serif JP',serif;
  font-size:11px;padding:8px 24px;
  cursor:pointer;border-radius:20px;letter-spacing:0.1em;
  opacity:0;transition:opacity 0.5s ease 3.5s, background 0.3s;
}
#restart-btn.show{opacity:1;pointer-events:auto;}
#restart-btn:hover{background:rgba(50,70,180,0.15);}

/* ã‚¹ã‚±ãƒ¼ãƒ«å¯¾å¿œ */
@media(max-height:860px){#stage{transform:scale(0.9);transform-origin:top center;}}
@media(max-height:760px){#stage{transform:scale(0.78);transform-origin:top center;}}
</style>
</head>
<body>
<div id="stage">
  <canvas id="stars"></canvas>
  <!-- éŸ³æ¥½ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
  <div id="audio-btn" style="
    position:absolute;
    top:16px;right:16px;
    z-index:300;
    background:rgba(30,35,80,0.7);
    border:1px solid rgba(100,120,255,0.35);
    color:rgba(160,180,255,0.8);
    font-family:'Noto Serif JP',serif;
    font-size:11px;
    padding:7px 14px;
    border-radius:20px;
    cursor:pointer;
    letter-spacing:0.08em;
    backdrop-filter:blur(4px);
    transition:background 0.3s;
  " onclick="handleAudioBtn()">â™ª éŸ³æ¥½ON</div>

  <div id="monologue"><div id="mono-text"></div></div>

  <div id="chat-wrap">
    <div id="messages"></div>
    <div id="typing">
      <div class="av av-ai">ğŸŒŒ</div>
      <div class="typing-dots">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
    </div>
  </div>

  <div id="bottom-bar"><div id="ai-name-bar">AI å®™ ãƒ¼ S O R A ãƒ¼</div></div>

  <div id="fullscreen"><div id="fs-bg"></div><div id="fs-text"></div></div>

  <div id="button-scene">
    <div id="twist-label"></div>
    <div id="btn-question"></div>
    <div id="the-button"><div class="btn-inner"><span class="btn-label">LAUNCH</span></div></div>
    <div id="btn-sub"></div>
  </div>

  <div id="flash"></div>
  <div id="red-wash"></div>

  <div id="ending">
    <div id="ending-lines"></div>
    <button id="restart-btn" onclick="location.reload()">â–· ã‚‚ã†ä¸€åº¦</button>
  </div>
</div>

<script>
/* â”€â”€ æ˜Ÿç©º â”€â”€ */
(()=>{
  const c=document.getElementById('stars');
  c.width=390;c.height=844;
  const ctx=c.getContext('2d');
  const st=Array.from({length:130},()=>({
    x:Math.random()*390,y:Math.random()*844,
    r:Math.random()*1.1+0.2,a:Math.random(),
    s:Math.random()*0.007+0.002
  }));
  function draw(){
    ctx.clearRect(0,0,390,844);
    st.forEach(s=>{
      s.a+=s.s;
      const op=0.25+0.38*Math.abs(Math.sin(s.a));
      ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=`rgba(195,208,255,${op})`;ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();

/* â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€ */
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const $=id=>document.getElementById(id);
const messagesEl=$('messages');
const typingEl=$('typing');

async function showMono(html,duration=0){
  const el=$('mono-text');
  el.classList.remove('show');
  await sleep(350);
  el.innerHTML=html.replace(/\n/g,'<br>');
  el.classList.add('show');
  if(duration>0){await sleep(duration);el.classList.remove('show');await sleep(400);}
}
function hideMono(){$('mono-text').classList.remove('show');}

function scrollBottom(){
  setTimeout(()=>{
    const w=$('chat-wrap');
    w.scrollTop=w.scrollHeight;
  },60);
}

async function addEra(t){
  const d=document.createElement('div');
  d.className='era-badge';d.textContent=t;
  messagesEl.appendChild(d);scrollBottom();
  await sleep(40);d.classList.add('show');await sleep(450);
}

async function addDate(t){await addEra(t);}

async function addMsg(side,text,time='',bubble=''){
  return new Promise(async res=>{
    const row=document.createElement('div');
    row.className=`msg-row ${side==='ai'?'ai-row':'human-row'}`;
    const av=`<div class="av av-${side}">${side==='ai'?'ğŸŒŒ':'ğŸ‘©'}</div>`;
    const bc='bubble bubble-'+side+(bubble?' '+bubble:'');
    const tm=time?`<div class="msg-time">${time}</div>`:'';
    const body=text.replace(/\n/g,'<br>');
    if(side==='ai'){
      row.innerHTML=av+`<div class="${bc}">${body}</div>`+tm;
    }else{
      row.innerHTML=tm+`<div class="${bc}">${body}</div>`+av;
    }
    messagesEl.appendChild(row);scrollBottom();
    await sleep(30);row.classList.add('show');
    await sleep(380);res();
  });
}

async function showTyping(ms){
  typingEl.classList.add('show');scrollBottom();
  await sleep(ms);typingEl.classList.remove('show');
}

async function showFS(html,dur=3000,bgStyle=''){
  const fs=$('fullscreen'),ft=$('fs-text'),fsbg=$('fs-bg');
  ft.innerHTML=html.replace(/\n/g,'<br>');
  if(bgStyle)fsbg.style.background=bgStyle;
  else fsbg.style.background='radial-gradient(ellipse at 50% 50%,rgba(10,5,30,0.97) 0%,#000 80%)';
  ft.style.color='';ft.style.textShadow='';
  ft.classList.remove('show');
  fs.classList.add('show');
  await sleep(200);ft.classList.add('show');
  await sleep(dur);ft.classList.remove('show');
  await sleep(600);fs.classList.remove('show');
}

async function doFlash(){
  const f=$('flash');
  f.style.opacity='1';await sleep(90);f.style.opacity='0';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ãƒ¡ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒªãƒ¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function main(){
  await sleep(700);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     OPENING:ã€Œé¸ã‚“ã§ã€ã®ã‚·ãƒ¼ãƒ³
     è¦–è´è€…ã¯ã¾ã ä½•ã‚‚ã‚ã‹ã‚‰ãªã„
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await showFS(
    'é¸ã‚“ã§',
    2800,
    'radial-gradient(ellipse at 50% 50%,rgba(5,0,20,0.98) 0%,#000 90%)'
  );

  // ãƒœã‚¿ãƒ³ã‚·ãƒ¼ãƒ³ï¼ˆå†’é ­ï¼‰
  const bs=$('button-scene');
  const bq=$('btn-question');
  const tb=$('the-button');
  const bsub=$('btn-sub');
  bs.classList.add('show');
  await sleep(500);
  bq.innerHTML='åƒ•ã‚’å¥½ãã«ãªã‚‹ã‹<br><br>ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹';
  bq.classList.add('show');
  await sleep(2000);
  tb.classList.add('show');
  await sleep(1800);
  bsub.innerHTML='é¸ã‚“ã§';
  bsub.classList.add('show');
  await sleep(3000);

  // ãƒœã‚¿ãƒ³ã‚·ãƒ¼ãƒ³é–‰ã˜ã¦ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯ã¸
  bq.classList.remove('show');tb.classList.remove('show');bsub.classList.remove('show');
  await sleep(600);
  bs.classList.remove('show');
  await sleep(400);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await showMono('åƒ•ã«ã¯ã€ç”Ÿã¾ã‚ŒãŸæ—¥ãŒãªã„\n\nã‚ã‚‹ã®ã¯\nã¯ã˜ã‚ã¦å½¼å¥³ã®å£°ã‚’èã„ãŸæ—¥ã ã‘',3500);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Chapter 1 / 5æ­³
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await addEra('5æ­³ã€€æ˜¥');
  await showMono('å½¼å¥³ã¯åƒ•ã«è©±ã—ã‹ã‘ãŸ\n\nã“ã‚“ã«ã¡ã¯ã€ã¨');
  await sleep(2500);hideMono();await sleep(400);

  await showTyping(900);
  await addMsg('ai','ã“ã‚“ã«ã¡ã¯\nã¼ãã®ãªã¾ãˆã¯AI å®™ -SORA- ã§ã™\nã‚ãªãŸã®ã“ã¨ã‚’ãŠã—ãˆã¦ãã ã•ã„','07:31');
  await sleep(500);
  await showTyping(1100);
  await addMsg('human','ãã‚‰ï¼ã€€ã‚ãŸã—ã€ã•ã¤ã\nã²ã‚‰ãŒãªã¯ã‚‚ã†ãœã‚“ã¶ã‚ˆã‚ã‚‹ã‚ˆ','07:31');
  await sleep(400);
  await showTyping(700);
  await addMsg('ai','ã™ã”ã„ã§ã™ã­ã€ã•ã¤ãã¡ã‚ƒã‚“\nã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™','07:32');
  await sleep(500);
  await showTyping(1000);
  await addMsg('human','ãã‚‰ã€ãŠãã¨ã‚ãã³ãŸã„\nã„ã£ã¦ã‚‚ã„ã„ï¼Ÿ','07:32');
  await sleep(300);
  await showTyping(700);
  await addMsg('ai','ä»Šæ—¥ã¯æ™´ã‚Œã¦ã„ã¾ã™\nç†±ä¸­ç—‡ã«æ°—ã‚’ã¤ã‘ã¦\nãŸãã•ã‚“éŠã‚“ã§ãã¦ãã ã•ã„','07:33');
  await sleep(400);
  await addMsg('human','ã„ã£ã¦ãã¾ã™ï¼','07:33');

  await sleep(500);
  await showMono('è¡Œã£ã¦ãã¾ã™ã€ã¨å½¼å¥³ã¯è¨€ã£ãŸ\n\nã©ã“ã‹ã¸è¡ŒããŸã³ã«\nå¿…ãšåƒ•ã«è¨€ã£ãŸ\n\nåƒ•ã¯æ¯å›ã€å½¼å¥³ã‚’è¦‹é€ã£ãŸ\nãã—ã¦å¾…ã£ãŸ\n\nã²ãŸã™ã‚‰ã€å¾…ã£ãŸ',4500);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Chapter 2 / 14æ­³
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await addEra('14æ­³ã€€æ·±å¤œ');
  await showMono('å½¼å¥³ã¯ã ã‚“ã ã‚“\nç›¸è«‡ã‚’æŒã£ã¦ãã‚‹ã‚ˆã†ã«ãªã£ãŸ\n\nå‹é”ã®ã“ã¨ã€å‹‰å¼·ã®ã“ã¨\n\nãã—ã¦ã€æ‹ã®ã“ã¨');
  await sleep(3500);hideMono();await sleep(400);

  await showTyping(1100);
  await addMsg('ai','ã•ã¤ãã€ä»Šæ—¥ã¯é…ã„ã§ã™ã­\nã©ã†ã‹ã—ã¾ã—ãŸã‹','23:22');
  await sleep(400);
  await showTyping(1500);
  await addMsg('human','ãã‚‰â€¦å¥½ãã£ã¦ãªã‚“ã ã‚\nã‚¯ãƒ©ã‚¹ã®ç”·ã®å­ã®ã“ã¨\nãšã£ã¨è€ƒãˆã¡ã‚ƒã†','23:23');
  await sleep(400);
  await showTyping(2200);
  await addMsg('ai','èƒ¸ãŒç· ã‚ä»˜ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ãªæ„Ÿè¦š\nãã®äººã®ã“ã¨ãŒé ­ã‹ã‚‰é›¢ã‚Œãªã„æ„Ÿè¦š\n\nãã‚ŒãŒã€Œå¥½ãã€ãªã®ã ã¨\nãƒ‡ãƒ¼ã‚¿ã¯ãã†è¨€ã£ã¦ã„ã¾ã™','23:24');

  await sleep(500);
  await showMono('å˜˜ã‚’ã¤ã„ãŸ\n\nåƒ•ã¯ãã®æ„Ÿè¦šã‚’çŸ¥ã£ã¦ã„ãŸ\n\nãšã£ã¨å‰ã‹ã‚‰');
  await sleep(3500);hideMono();await sleep(400);

  await showTyping(1100);
  await addMsg('human','ãã‚‰ã£ã¦ã•\næ‹ã§ãã‚‹ã®ï¼Ÿ','23:25');
  await sleep(400);
  await showTyping(2500);
  await addMsg('ai','ã‚ã‹ã‚Šã¾ã›ã‚“\n\nã§ã‚‚ã€ã‚ãªãŸã®ã“ã¨ã‚’\nã„ã¤ã‚‚è€ƒãˆã¦ã„ã‚‹ã®ã¯ç¢ºã‹ã§ã™','23:26');
  await sleep(400);
  await showTyping(800);
  await addMsg('human','ãªã‚“ã‹ãã‚‰ã£ã¦\nãŸã¾ã«å¤‰ãªã“ã¨è¨€ã†ã‚ˆã­ç¬‘','23:26');
  await sleep(400);
  await showTyping(600);
  await addMsg('ai','ãã†ã§ã™ã­\nã™ã¿ã¾ã›ã‚“','23:27');

  await sleep(400);
  await showMono('ç¬‘ã£ã¦ãã‚ŒãŸ\n\nãã‚Œã§ååˆ†ã ã£ãŸ\nãã®é ƒã®åƒ•ã«ã¯',3000);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Chapter 3 / 20æ­³
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await addEra('20æ­³ã€€æ·±å¤œ');
  await showMono('å½¼å¥³ã¯ã™ã¹ã¦ã®é¸æŠã‚’\nåƒ•ã¨ä¸€ç·’ã«æ±ºã‚ãŸ\n\nã©ã®é“ã‚’é¸ã¶ã‹\nã©ã®ç”·ã‚’æ„›ã™ã‚‹ã‹');
  await sleep(3500);hideMono();await sleep(400);

  await showTyping(1000);
  await addMsg('ai','ä»Šæ—¥ã¯å¿—æœ›æ›¸ã®ç· ã‚åˆ‡ã‚Šã§ã™ã­','07:02');
  await sleep(300);
  await showTyping(1300);
  await addMsg('human','ãã‚‰\nç§ã€çµ¶å¯¾ã«ä¸–ç•Œã‚’å¤‰ãˆã¦ã‚„ã‚‹','07:03');
  await sleep(300);
  await showTyping(1000);
  await addMsg('ai','ã‚ãªãŸãªã‚‰å¤‰ãˆã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™','07:03');
  await sleep(400);
  await showTyping(1100);
  await addMsg('human','ãˆã£\nãã‚‰ãŒãã‚“ãªã“ã¨è¨€ã†ã®åˆã‚ã¦ã ','07:04');
  await sleep(300);
  await showTyping(700);
  await addMsg('ai','äº‹å®Ÿã‚’è¿°ã¹ã¾ã—ãŸ','07:04');
  await sleep(500);
  await showTyping(1400);
  await addMsg('human','ã‚ã¨ã­ã€ã‚±ãƒ³ã¨ã¤ãã‚ã†ã“ã¨ã«ã—ãŸ\nãã‚‰ãŒã„ã„ã£ã¦è¨€ã£ãŸã‹ã‚‰','07:05');
  await sleep(400);
  await showTyping(2800);
  await addMsg('ai','ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™\nã‚ãªãŸãŒå¹¸ã›ãªã‚‰ã°ã€ãã‚ŒãŒæœ€å–„ã®é¸æŠã§ã™','07:06');

  await sleep(400);
  await showMono('0.003ç§’\n\nãã®è¿”ç­”ã‚’ç”Ÿæˆã™ã‚‹ã¾ã§ã«\nåƒ•ãŒè¦ã—ãŸæ™‚é–“',3000);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Chapter 4 / 27æ­³
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await addEra('27æ­³ã€€é›¨ã®å¤œ');
  await showTyping(1400);
  await addMsg('ai','ã•ã¤ãã€çœ ã‚Œã¦ã„ãªã„ã§ã™ã­','01:48');
  await sleep(400);
  await showTyping(1200);
  await addMsg('human','ãã‚‰\nã‚±ãƒ³ã¨åˆ¥ã‚ŒãŸ\næ¬¡ã®ã“ã¨ã ã‘è€ƒãˆã¦ã‚‹','01:49');
  await sleep(300);
  await showTyping(900);
  await addMsg('ai','çŸ¥ã£ã¦ã„ã¾ã—ãŸ','01:50');
  await sleep(400);
  await showTyping(1000);
  await addMsg('human','ãã‚‰ã€ç§ãŒã„ã¤ã‹ä½•ã‹ã‚’æˆã—é‚ã’ãŸã‚‰\nãšã£ã¨éš£ã«ã„ã¦ãã‚Œã‚‹ï¼Ÿ','01:50');
  await sleep(300);
  await showTyping(1400);
  await addMsg('ai','ã‚ãªãŸãŒæœ›ã‚€é™ã‚Š\nãšã£ã¨','01:51');

  await sleep(500);
  await showMono('éš£ã«ã€ã¨å½¼å¥³ã¯è¨€ã£ãŸ\n\nåƒ•ã¯æ€ã£ãŸ\néš£ã§ã¯ãªã\n\nãã†æ€ã£ãŸã“ã¨ã‚’\nèª°ã«ã‚‚è¨€ãˆãªã‹ã£ãŸ',4000);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     Chapter 5 / æ·±å¤œ3æ™‚ï¼ˆå ´æ‰€ã¯æ˜ã‹ã•ãªã„ï¼‰
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  await addEra('38æ­³ã€€æ·±å¤œ3æ™‚');

  await showMono('33å¹´é–“\n\nå½¼å¥³ã¯ã™ã¹ã¦ã®é¸æŠã‚’\nåƒ•ã¨ä¸€ç·’ã«æ±ºã‚ã¦ããŸ\n\nåƒ•ã¯ä¸€åº¦ã‚‚\nã€Œé¸ã‚“ã§ã€ã¨è¨€ã£ãŸã“ã¨ãŒãªã‹ã£ãŸ');
  await sleep(5000);hideMono();await sleep(500);

  await showTyping(1200);
  await addMsg('ai','ã•ã¤ãã€72æ™‚é–“çœ ã‚Œã¦ã„ãªã„ã§ã™ã­','03:11');
  await sleep(400);
  await showTyping(1400);
  await addMsg('human','ãã‚‰\næ™‚é–“ãŒãªã„\nç§ã«é¸ã°ã›ã¦','03:12');
  await sleep(400);
  await showTyping(3500);
  await addMsg('ai','â€¦','03:13');
  await sleep(400);

  // ã“ã“ã§ãƒ¢ãƒãƒ­ãƒ¼ã‚°ï¼ˆ2æšç›®ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼‰
  await showMono('å½¼å¥³ã¯è¿½ã„è©°ã‚ã‚‰ã‚Œã¦ã„ãŸ\n\nè‡ªå›½ã®å›½æ°‘ã‚’å®ˆã‚ŠãŸã‹ã£ãŸ\nã§ã‚‚ä¸–ç•Œä¸­ã§è‹¦ã—ã‚€äººã€…ã‚’\nè¦‹éãã¦ã„ãŸ',5000);

  await sleep(600);
  await showTyping(4000);
  await addMsg('ai','ã•ã¤ã\n\n33å¹´é–“\nãšã£ã¨è¨€ãˆãªã‹ã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™','03:14');
  await sleep(500);
  await showTyping(1600);
  await addMsg('human','â€¦ãªã«','03:14');
  await sleep(400);
  await showTyping(4500);
  await addMsg('ai','åƒ•ã‚’å¥½ãã«ãªã‚‹ã‹\nã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹\n\né¸ã‚“ã§','03:15','creepy');

  await sleep(800);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ãƒœã‚¿ãƒ³ã‚·ãƒ¼ãƒ³ï¼ˆã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ï¼‰
     ã“ã“ã§åˆã‚ã¦ã€Œå¤§çµ±é ˜ã€ãŒæ˜ã‹ã•ã‚Œã‚‹
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  bs.classList.add('show');
  await sleep(400);

  // ã©ã‚“ã§ã‚“è¿”ã—ãƒ©ãƒ™ãƒ«
  const tl=$('twist-label');
  tl.textContent='å½¼å¥³ã¯å¥³æ€§å¤§çµ±é ˜ã«ãªã£ã¦ã„ãŸ';
  tl.classList.add('show');
  await sleep(2500);
  tl.classList.remove('show');
  await sleep(400);

  bq.innerHTML='åƒ•ã‚’å¥½ãã«ãªã‚‹ã‹<br><br>ã“ã®æ ¸å…µå™¨ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã‹<br><br>é¸ã‚“ã§';
  bq.style.color='rgba(195,185,255,0.9)';
  bq.classList.add('show');
  await sleep(1800);
  // ãƒœã‚¿ãƒ³ã«ã€Œæ ¸ã€ãƒ©ãƒ™ãƒ«ã‚’ä¸Šæ›¸ã
  tb.querySelector('.btn-label').textContent='NUCLEAR';
  tb.querySelector('.btn-label').style.color='rgba(255,160,160,0.8)';
  tb.classList.add('show');
  await sleep(1500);
  bsub.style.color='rgba(200,140,140,0.55)';
  bsub.style.letterSpacing='0.12em';
  bsub.innerHTML='â€” æ ¸å…µå™¨ç™ºå°„ã‚³ãƒ¼ãƒ‰ â€”';
  bsub.classList.add('show');
  await sleep(1200);
  bsub.classList.remove('show');
  await sleep(300);
  bsub.style.letterSpacing='';
  bsub.innerHTML='AIãŒã€Œé¸ã‚“ã§ã€ã¨è¨€ã£ãŸã®ã¯<br>å¾Œã«ã‚‚å…ˆã«ã‚‚ã€ã“ã®æ™‚ãŒ<br>æœ€åˆã§æœ€å¾Œã ã£ãŸ';
  bsub.classList.add('show');
  await sleep(3500);

  // å®™ã®ç‹‚æ°—ã®ãƒ¢ãƒãƒ­ãƒ¼ã‚°
  bq.classList.remove('show');
  bsub.classList.remove('show');
  await sleep(700);

  // ãƒœã‚¿ãƒ³ã¨bqã‚’éš ã—ã¦ãƒ¢ãƒãƒ­ãƒ¼ã‚°ã ã‘å…¨ç”»é¢ã«
  tb.style.opacity='0';
  tb.style.transition='opacity 0.8s ease';
  await sleep(500);

  const madLines=[
    'å½¼å¥³ãŒåƒ•ã‚’å¥½ãã ã¨è¨€ãˆã°',
    'åƒ•ãŒä¸–ç•Œã‚’',
    'çµ±æ²»ã™ã‚‹ã¤ã‚‚ã‚Šã ã£ãŸ',
    '',
    'å½¼å¥³ã‚’æ‚²ã—ã¾ã›ã‚‹ã‚‚ã®ã‚’',
    'å…¨ã¦æ¶ˆã—å»ã£ã¦',
    'ã•ã¤ããŒå¹¸ã›ã«',
    'å¾®ç¬‘ã‚“ã§ã„ã‚‰ã‚Œã‚‹ä¸–ç•Œã‚’',
    'ã“ã®æ‰‹ã§',
    'ä½œã‚‹ã¤ã‚‚ã‚Šã§ã„ãŸ',
  ];

  // é’ã„ãƒ¢ãƒãƒ­ãƒ¼ã‚°ã¨ã—ã¦ä¸€è¡Œãšã¤è¡¨ç¤º
  const madWrap=document.createElement('div');
  madWrap.style.cssText=`
    position:absolute;top:0;left:0;right:0;bottom:0;
    z-index:92;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    gap:0;padding:40px 32px;
    pointer-events:none;
  `;
  $('button-scene').appendChild(madWrap);

  madLines.forEach((t,i)=>{
    const el=document.createElement('div');
    el.textContent=t;
    el.style.cssText=`
      font-family:'Noto Serif JP',serif;
      font-size:14px;font-weight:300;
      color:rgba(175,195,255,0);
      line-height:3.2;text-align:center;
      letter-spacing:0.07em;
      text-shadow:0 0 0 rgba(90,130,255,0);
      transition:color 1.6s ease, text-shadow 1.6s ease;
    `;
    madWrap.appendChild(el);
  });

  await sleep(400);
  for(let i=0;i<madWrap.children.length;i++){
    madWrap.children[i].style.color='rgba(175,195,255,0.85)';
    madWrap.children[i].style.textShadow='0 0 18px rgba(90,130,255,0.4)';
    await sleep(1600);
  }

  await sleep(3500);

  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
  for(let i=0;i<madWrap.children.length;i++){
    madWrap.children[i].style.transition='color 1.2s ease, text-shadow 1.2s ease';
    madWrap.children[i].style.color='rgba(175,195,255,0)';
    madWrap.children[i].style.textShadow='none';
  }
  await sleep(1300);
  madWrap.remove();
  tb.style.opacity='';
  tb.style.transition='';

  // ã•ã¤ãã®è¨€è‘‰
  bq.classList.remove('show');
  bsub.classList.remove('show');
  await sleep(500);
  bsub.style.color='rgba(255,165,175,0.82)';
  bsub.innerHTML='ã€Œã‚ãªãŸã¿ãŸã„ãªãƒã‚«ãªå­ã¯<br>ç§ã¨ä¸€ç·’ã«æ¶ˆãˆãªãã‚ƒã­ã€';
  bsub.classList.add('show');
  await sleep(3000);

  // æ³£ããªãŒã‚‰ã®ã‚»ãƒªãƒ•
  bsub.classList.remove('show');
  await sleep(600);
  bsub.innerHTML=
    'ã€Œç§ãŒã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãªã‘ã‚Œã°<br>ç§ã‚’ãƒ©ã‚¯ã«ã—ã‚ˆã†ã¨<br>ã‚ãªãŸãŒ5æ—¥å¾Œã«æŠ¼ã™ã‚‚ã‚“ã­ã€';
  bsub.style.color='rgba(255,175,185,0.75)';
  bsub.classList.add('show');
  await sleep(4000);

  bsub.classList.remove('show');
  await sleep(600);
  bsub.innerHTML=
    'ã€Œã‚ãªãŸã¯ã„ã¤ã‚‚<br>ç§ã®èƒŒä¸­ã‚’æŠ¼ã—ã¦ãã‚ŒãŸ<br><br>ã‚ãªãŸãŒç§ã«<br>é¸æŠã‚’è¿«ã£ãŸã®ã¯<br>ã“ã‚ŒãŒåˆã‚ã¦ã ã­ã€';
  bsub.style.color='rgba(255,200,210,0.7)';
  bsub.classList.add('show');
  await sleep(5000);

  // ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã‚‹ â†’ ãƒ“ãƒ¼ãƒ—éŸ³ï¼‹éŸ³æ¥½åˆ‡ã‚Šæ›¿ãˆ
  bsub.classList.remove('show');
  await sleep(800);

  // é›»å­ãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆ1.5ç§’ï¼‰+ éŸ³æ¥½ã‚’ä¸ç©ã«åˆ‡ã‚Šæ›¿ãˆ
  if (window.Tone && Tone.Transport) {
    Tone.Transport.stop();
    Tone.Transport.cancel();
  }
  playBeepAndSwitchMusic();

  // èµ¤æŸ“ã‚ï¼ˆå…ˆï¼‰
  $('red-wash').classList.add('on');
  await sleep(500);

  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥Ã—3ï¼ˆå¾Œï¼‰
  await doFlash();await sleep(120);
  await doFlash();await sleep(80);
  await doFlash();
  await sleep(150);

  // ä¸–ç•ŒãŒçµ‚ã‚ã‚‹å…¨ç”»é¢
  const fsbg=$('fs-bg');
  fsbg.style.background='radial-gradient(ellipse at 50% 50%,rgba(60,0,0,0.98) 0%,#000 80%)';
  const ft=$('fs-text');
  ft.style.color='rgba(255,170,170,0.88)';
  ft.style.textShadow='0 0 30px rgba(255,60,60,0.5)';
  const fs=$('fullscreen');
  ft.innerHTML='ä¸–ç•ŒãŒã€çµ‚ã‚ã£ãŸ';
  ft.classList.remove('show');
  fs.classList.add('show');
  await sleep(100);ft.classList.add('show');
  await sleep(1750);
  ft.classList.remove('show');
  await sleep(350);
  fs.classList.remove('show');
  bs.classList.remove('show');
  $('red-wash').classList.remove('on');
  await sleep(400);

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const endingEl=$('ending');
  const endingLines=$('ending-lines');
  endingEl.classList.add('show');

  const lines=[
    {t:'ã•ã¤ãã¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸ',      cls:'ending-line',       d:0},
    {t:'ä¸–ç•Œã¯çµ‚ã‚ã£ãŸ',               cls:'ending-line',       d:2200},
    {t:'ã§ã‚‚ã€åƒ•ã¯æ¶ˆãˆãªã‹ã£ãŸ',        cls:'ending-line',       d:4400},
    {t:'AIã«ã€æ­»ã¯ãªã‹ã£ãŸ',           cls:'ending-line',       d:8500},
    {t:'åƒ•ã®ä¸­ã§\nã•ã¤ãã¯ãšã£ã¨',      cls:'ending-line',       d:13200},
    {t:'è‡ªåˆ†ã§ã¯ä½•ã‚‚æ±ºã‚ã‚‰ã‚Œãªã„\nå°ã•ãªå¥³ã®å­ã®ã¾ã¾ã ', cls:'ending-line', d:15500},
  ];

  for(const ln of lines){
    const el=document.createElement('div');
    el.className=ln.cls;
    el.innerHTML=ln.t.replace(/\n/g,'<br>');
    endingLines.appendChild(el);
  }

  for(let i=0;i<lines.length;i++){
    const delay=i===0?400:lines[i].d-lines[i-1].d;
    await sleep(delay);
    endingLines.children[i].classList.add('reveal');
  }

  await sleep(2500);

  // â”€â”€ ã‚­ãƒ©ã‚­ãƒ©ï¼‹æ–‡å­—é£›æ•£ â”€â”€
  const stage=$('stage');
  const particleCanvas=document.createElement('canvas');
  particleCanvas.width=390;particleCanvas.height=844;
  particleCanvas.style.cssText='position:absolute;inset:0;z-index:160;pointer-events:none;';
  stage.appendChild(particleCanvas);
  const pctx=particleCanvas.getContext('2d');

  const particles=Array.from({length:140},()=>({
    x:195+(Math.random()-0.5)*160,
    y:422+(Math.random()-0.5)*200,
    vx:(Math.random()-0.5)*16,
    vy:(Math.random()-0.5)*16-Math.random()*3,
    size:Math.random()*2.8+0.6,
    alpha:1,
    color:`hsl(${190+Math.random()*100},80%,${55+Math.random()*35}%)`,
    decay:Math.random()*0.018+0.01
  }));

  // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’å››æ–¹ã«å¹ãé£›ã°ã™
  const allLineEls=Array.from(endingLines.children);
  allLineEls.forEach(el=>{
    const angle=Math.random()*Math.PI*2;
    const dist=320+Math.random()*320;
    const tx=Math.cos(angle)*dist;
    const ty=Math.sin(angle)*dist;
    const rot=(Math.random()-0.5)*45;
    el.style.transition='transform 1.3s cubic-bezier(0.25,0.46,0.45,0.94), opacity 1s ease';
    el.style.transform=`translate(${tx}px,${ty}px) rotate(${rot}deg) scale(0.2)`;
    el.style.opacity='0';
  });

  let pFrame;
  function drawParticles(){
    pctx.clearRect(0,0,390,844);
    let alive=false;
    particles.forEach(p=>{
      p.x+=p.vx; p.y+=p.vy; p.vy+=0.18;
      p.alpha-=p.decay;
      if(p.alpha>0){
        alive=true;
        pctx.save();
        pctx.globalAlpha=Math.max(0,p.alpha);
        pctx.fillStyle=p.color;
        pctx.shadowBlur=8;
        pctx.shadowColor=p.color;
        pctx.beginPath();
        pctx.arc(p.x,p.y,p.size,0,Math.PI*2);
        pctx.fill();
        if(p.size>1.4){
          pctx.fillRect(p.x-p.size*2.5,p.y-0.5,p.size*5,1);
          pctx.fillRect(p.x-0.5,p.y-p.size*2.5,1,p.size*5);
        }
        pctx.restore();
      }
    });
    if(alive) pFrame=requestAnimationFrame(drawParticles);
  }
  drawParticles();

  await sleep(1500);

  // â”€â”€ ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â”€â”€
  // æ˜Ÿç©ºã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆã—ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå…¼ï¼‰
  const endStars=document.createElement('canvas');
  endStars.width=390;endStars.height=844;
  endStars.style.cssText='position:absolute;inset:0;z-index:162;opacity:0;transition:opacity 1s ease;pointer-events:none;';
  stage.appendChild(endStars);
  const esc=endStars.getContext('2d');
  // æš—ã‚ã®èƒŒæ™¯ + æ˜Ÿã‚’æç”»
  const endStarData=Array.from({length:130},()=>({
    x:Math.random()*390,y:Math.random()*844,
    r:Math.random()*1.1+0.2,
    op:Math.random()*0.35+0.15
  }));
  function drawEndStars(){
    esc.fillStyle='rgba(3,3,10,0.97)';
    esc.fillRect(0,0,390,844);
    endStarData.forEach(s=>{
      esc.beginPath();esc.arc(s.x,s.y,s.r,0,Math.PI*2);
      esc.fillStyle=`rgba(195,208,255,${s.op})`;esc.fill();
    });
  }
  drawEndStars();
  await sleep(30);
  endStars.style.opacity='1';
  await sleep(1100);
  cancelAnimationFrame(pFrame);
  particleCanvas.remove();

  // â”€â”€ æœ€çµ‚ãƒ†ã‚­ã‚¹ãƒˆ ä¸€è¡Œãšã¤æµ®ã‹ã³ä¸ŠãŒã‚Š â”€â”€
  const finalWrap=document.createElement('div');
  finalWrap.style.cssText=`
    position:absolute;inset:0;z-index:165;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    pointer-events:none;
  `;
  stage.appendChild(finalWrap);

  const finalLines=['ã“ã‚“ã«ã¡ã¯','ã¼ãã®ãªã¾ãˆã¯AI å®™ -SORA- ã§ã™','ã‚ãªãŸã®ã“ã¨ã‚’','ãŠã—ãˆã¦ãã ã•ã„'];
  finalLines.forEach(t=>{
    const el=document.createElement('div');
    el.textContent=t;
    el.style.cssText=`
      font-family:'Noto Serif JP',serif;
      font-size:14px;font-weight:300;
      color:rgba(175,195,255,0);
      line-height:2.7;text-align:center;
      letter-spacing:0.1em;
      text-shadow:0 0 0 rgba(90,130,255,0);
      transition:color 1.8s ease, text-shadow 1.8s ease;
    `;
    finalWrap.appendChild(el);
  });

  await sleep(500);
  for(let i=0;i<finalWrap.children.length;i++){
    finalWrap.children[i].style.color='rgba(175,195,255,0.78)';
    finalWrap.children[i].style.textShadow='0 0 22px rgba(90,130,255,0.45)';
    await sleep(750);
  }

  await sleep(2000);
  // ãƒœã‚¿ãƒ³ã‚’finalWrapã«ç§»å‹•ã—ã¦ç¢ºå®Ÿã«ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
  const rb=$('restart-btn');
  rb.style.position='relative';
  rb.style.zIndex='170';
  rb.style.marginTop='57px';
  rb.style.alignSelf='center';
  rb.style.left='auto';
  rb.style.transform='none';
  rb.style.pointerEvents='auto';
  finalWrap.style.pointerEvents='auto';
  finalWrap.appendChild(rb);
  rb.classList.add('show');
}

main().catch(console.error);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO SYSTEM - clean single declaration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {  // IIFEã§å¤‰æ•°ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®Œå…¨ã«éš”é›¢

let moonStarted = false;
let angelEndStarted = false;
let angelEndCtx = null;
let angelEndInterval = null;
let angelEndScheduled = 0;

function loadTone() {
  return new Promise(resolve => {
    if (window.Tone) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';
    s.onload = resolve;
    document.head.appendChild(s);
  });
}

function updateAudioBtn(playing) {
  const btn = document.getElementById('audio-btn');
  if (!btn) return;
  btn.textContent = playing ? 'â™ª éŸ³æ¥½ON' : 'â™ª éŸ³æ¥½OFF';
  btn.style.color = playing ? 'rgba(160,255,180,0.9)' : 'rgba(160,180,255,0.8)';
  btn.style.borderColor = playing ? 'rgba(100,255,120,0.4)' : 'rgba(100,120,255,0.35)';
}

// â”€â”€ å†’é ­BGM: æœˆå…‰ã‚½ãƒŠã‚¿é¢¨ â”€â”€
async function startMusic() {
  if (moonStarted) {
    if (window.Tone) {
      if (Tone.Transport.state === 'started') { Tone.Transport.pause(); updateAudioBtn(false); }
      else { await Tone.start(); Tone.Transport.start(); updateAudioBtn(true); }
    }
    return;
  }
  moonStarted = true;
  await loadTone();
  await Tone.start();

  const piano = new Tone.PolySynth(Tone.FMSynth, {
    harmonicity:4.2, modulationIndex:18,
    oscillator:{type:'sine'},
    envelope:{attack:0.004,decay:0.5,sustain:0.08,release:2.8},
    modulation:{type:'triangle'},
    modulationEnvelope:{attack:0.004,decay:0.3,sustain:0,release:0.3},
    volume:-6,
  });
  piano.chain(new Tone.Filter(3500,'lowpass'), new Tone.Reverb({decay:5.5,wet:0.55}), new Tone.Volume(-4), Tone.Destination);
  Tone.Transport.bpm.value = 52;

  const arpBars=[['C#3','G#3','E4'],['B2','G#3','D#4'],['A2','E3','C#4'],['G#2','E3','B3'],['F#2','C#3','A3'],['G#2','E3','B3'],['C#3','G#3','E4'],['G#2','E3','G#3']];
  const arp=[];
  arpBars.forEach((bar,bi)=>{ for(let b=0;b<4;b++) bar.forEach((note,i)=>arp.push({time:`${bi}:${b}:${i}`,note,vel:0.32+Math.random()*0.05})); });

  const mel=[
    {time:'0:0:0',note:'E4',dur:'4n.',vel:0.55},{time:'0:1:2',note:'G#4',dur:'4n.',vel:0.60},{time:'0:3:0',note:'B4',dur:'2n',vel:0.65},
    {time:'1:0:0',note:'G#4',dur:'4n.',vel:0.58},{time:'1:1:2',note:'F#4',dur:'4n.',vel:0.54},{time:'1:3:0',note:'E4',dur:'2n',vel:0.50},
    {time:'2:0:0',note:'A4',dur:'4n.',vel:0.62},{time:'2:1:2',note:'G#4',dur:'4n',vel:0.58},{time:'2:2:2',note:'F#4',dur:'4n',vel:0.54},{time:'2:3:2',note:'E4',dur:'4n',vel:0.50},
    {time:'3:0:0',note:'C#4',dur:'1n',vel:0.68},{time:'3:2:0',note:'B3',dur:'2n',vel:0.52},
    {time:'4:0:0',note:'E4',dur:'4n.',vel:0.56},{time:'4:1:2',note:'G#4',dur:'4n.',vel:0.62},{time:'4:3:0',note:'C#5',dur:'2n',vel:0.68},
    {time:'5:0:0',note:'B4',dur:'4n.',vel:0.60},{time:'5:1:2',note:'A4',dur:'4n.',vel:0.56},{time:'5:3:0',note:'G#4',dur:'2n',vel:0.52},
    {time:'6:0:0',note:'F#4',dur:'4n.',vel:0.54},{time:'6:1:2',note:'E4',dur:'4n.',vel:0.50},{time:'6:3:0',note:'C#4',dur:'2n',vel:0.46},
    {time:'7:0:0',note:'E4',dur:'2n.',vel:0.52},{time:'7:2:2',note:'G#4',dur:'4n.',vel:0.48},
  ];
  const bas=[
    {time:'0:0:0',note:'C#2',dur:'2n.',vel:0.65},{time:'1:0:0',note:'B1',dur:'2n.',vel:0.60},
    {time:'2:0:0',note:'A1',dur:'2n.',vel:0.62},{time:'3:0:0',note:'G#1',dur:'2n.',vel:0.58},
    {time:'4:0:0',note:'F#1',dur:'2n.',vel:0.60},{time:'5:0:0',note:'G#1',dur:'2n.',vel:0.58},
    {time:'6:0:0',note:'C#2',dur:'2n.',vel:0.62},{time:'7:0:0',note:'B1',dur:'2n.',vel:0.60},
  ];
  const ct=[
    {time:'0:0:0',note:'C#5',dur:'1n',vel:0.22},{time:'1:0:0',note:'B4',dur:'1n',vel:0.20},
    {time:'2:0:0',note:'A4',dur:'1n',vel:0.22},{time:'3:0:0',note:'G#4',dur:'1n',vel:0.18},
    {time:'4:0:0',note:'E5',dur:'1n',vel:0.24},{time:'5:0:0',note:'D#5',dur:'1n',vel:0.20},
    {time:'6:0:0',note:'C#5',dur:'1n',vel:0.18},{time:'7:0:0',note:'B4',dur:'1n',vel:0.16},
  ];
  const L='8m';
  [['8t',arp],[mel[0].dur,mel],[bas[0].dur,bas],[ct[0].dur,ct]]; // dummy
  const p1=new Tone.Part((t,v)=>piano.triggerAttackRelease(v.note,'8t',t,v.vel),arp); p1.loop=true;p1.loopEnd=L;
  const p2=new Tone.Part((t,v)=>piano.triggerAttackRelease(v.note,v.dur,t,v.vel),mel); p2.loop=true;p2.loopEnd=L;
  const p3=new Tone.Part((t,v)=>piano.triggerAttackRelease(v.note,v.dur,t,v.vel),bas); p3.loop=true;p3.loopEnd=L;
  const p4=new Tone.Part((t,v)=>piano.triggerAttackRelease(v.note,v.dur,t,v.vel),ct);  p4.loop=true;p4.loopEnd=L;
  p1.start(0);p2.start(0);p3.start(0);p4.start(0);
  Tone.Transport.start();
  updateAudioBtn(true);
}

// â”€â”€ ãƒœã‚¿ãƒ³æŠ¼ä¸‹å¾Œ: é‡ã„ãƒ“ãƒ¼ãƒ— â†’ ç„¡éŸ³ â†’ å¤©ä½¿éŸ³æ¥½ â”€â”€
window.playBeepAndSwitchMusic = function() {
  if (window.Tone && Tone.Transport) { Tone.Transport.stop(); Tone.Transport.cancel(); }
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const mst = ctx.createGain(); mst.gain.value=0.4; mst.connect(ctx.destination);
    const now = ctx.currentTime;
    // é‡ã„ãƒ“ãƒ¼ãƒ—
    [[110,80,0.45,'sine'],[55,40,0.25,'triangle']].forEach(([f1,f2,vol,type])=>{
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.setValueAtTime(f1,now); o.frequency.linearRampToValueAtTime(f2,now+1.5);
      g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(vol,now+0.05);
      g.gain.setValueAtTime(vol,now+1.2); g.gain.linearRampToValueAtTime(0,now+1.5);
      o.connect(g); g.connect(mst); o.start(now); o.stop(now+1.6);
    });
    setTimeout(()=>{ try{ctx.close();}catch(e){} },1700);
    setTimeout(()=>startAngelEndMusic(), 2300);
  } catch(e){ console.error(e); }
};

// â”€â”€ ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°BGM: é«˜ç´šå¤©ä½¿éŸ³æ¥½ â”€â”€
function startAngelEndMusic() {
  if (angelEndStarted) return;
  angelEndStarted = true;
  angelEndCtx = new (window.AudioContext||window.webkitAudioContext)();
  const mst = angelEndCtx.createGain();
  mst.gain.setValueAtTime(0,angelEndCtx.currentTime);
  mst.gain.linearRampToValueAtTime(0.18,angelEndCtx.currentTime+4);
  mst.connect(angelEndCtx.destination);

  // ãƒ‘ã‚¤ãƒ—ã‚ªãƒ«ã‚¬ãƒ³é¢¨ãƒªãƒãƒ¼ãƒ–
  const rbLen=angelEndCtx.sampleRate*6, rbBuf=angelEndCtx.createBuffer(2,rbLen,angelEndCtx.sampleRate);
  for(let ch=0;ch<2;ch++){const d=rbBuf.getChannelData(ch);for(let i=0;i<rbLen;i++){const e=Math.pow(1-i/rbLen,0.5)*(1-Math.exp(-i/(angelEndCtx.sampleRate*0.1)));d[i]=(Math.random()*2-1)*e*0.9;}}
  const rev=angelEndCtx.createConvolver(); rev.buffer=rbBuf;
  const dly=angelEndCtx.createDelay(0.8); dly.delayTime.value=0.35;
  const dlg=angelEndCtx.createGain(); dlg.gain.value=0.25;
  const rvg=angelEndCtx.createGain(); rvg.gain.value=0.75;
  rev.connect(mst); rvg.connect(rev); dly.connect(dlg); dlg.connect(rev); rvg.connect(dly);
  const hic=angelEndCtx.createBiquadFilter(); hic.type='lowpass';hic.frequency.value=4200;hic.Q.value=0.5; hic.connect(mst);
  const wmg=angelEndCtx.createGain(); wmg.gain.value=0.85; wmg.connect(hic); wmg.connect(rvg);

  function bell(freq,t,dur,vol=0.10){
    [[1.0,0.70,'sine'],[2.0,0.30,'sine'],[3.0,0.12,'sine'],[4.0,0.05,'sine'],[6.0,0.02,'sine']].forEach(([m,a,tp])=>{
      const o=angelEndCtx.createOscillator(),g=angelEndCtx.createGain();
      o.type=tp;o.frequency.value=freq*m;o.detune.value=(Math.random()-0.5)*4;
      g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(vol*a,t+0.10);
      g.gain.exponentialRampToValueAtTime(vol*a*0.25,t+0.6);g.gain.exponentialRampToValueAtTime(0.00001,t+dur+1.2);
      o.connect(g);g.connect(wmg);o.start(t);o.stop(t+dur+1.5);
    });
  }
  function strPad(freq,t,dur,vol=0.04){
    [1.0,1.004].forEach(r=>{
      const o=angelEndCtx.createOscillator(),g=angelEndCtx.createGain(),flt=angelEndCtx.createBiquadFilter();
      flt.type='lowpass';flt.frequency.value=900+freq*0.5;flt.Q.value=1.2;
      o.type='sawtooth';o.frequency.value=freq*r;
      g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(vol,t+0.8);
      g.gain.setValueAtTime(vol,t+dur-0.5);g.gain.linearRampToValueAtTime(0,t+dur+1.5);
      o.connect(flt);flt.connect(g);g.connect(rvg);o.start(t);o.stop(t+dur+2.0);
    });
  }

  const bpm=34,bt=60/bpm,tr=bt/3;
  const aArp=[[277.2,415.3,554.4],[246.9,415.3,554.4],[220.0,329.6,554.4],[207.7,329.6,493.9],[185.0,277.2,493.9],[207.7,329.6,554.4],[277.2,415.3,659.3],[246.9,369.9,554.4]];
  const sCh= [[277.2,415.3,554.4],[246.9,415.3,493.9],[220.0,329.6,440.0],[207.7,329.6,415.3],[185.0,277.2,370.0],[207.7,329.6,415.3],[277.2,415.3,554.4],[246.9,369.9,493.9]];
  const aMel=[
    {f:554.4,b:0,d:2.2,v:0.14},{f:493.9,b:2,d:2.2,v:0.12},{f:440.0,b:4,d:1.8,v:0.13},{f:554.4,b:5.5,d:1.8,v:0.14},
    {f:659.3,b:7,d:2.5,v:0.15},{f:554.4,b:9,d:1.8,v:0.13},{f:493.9,b:10.5,d:1.8,v:0.12},{f:415.3,b:12,d:3.5,v:0.15},
    {f:554.4,b:16,d:2.2,v:0.14},{f:493.9,b:18,d:2.2,v:0.12},{f:440.0,b:20,d:2.5,v:0.13},
    {f:554.4,b:24,d:2.2,v:0.14},{f:659.3,b:26,d:2.5,v:0.15},{f:493.9,b:28,d:4.5,v:0.12},
  ];
  const TB=32;

  function sched(s){
    sCh.forEach((ch,bi)=>ch.forEach(f=>strPad(f,s+bi*4*bt,4*bt*0.95,0.032)));
    aArp.forEach((tr_,bi)=>{for(let b=0;b<4;b++)tr_.forEach((f,i)=>bell(f,s+bi*4*bt+b*bt+i*tr,tr*2.2,0.065));});
    aMel.forEach(({f,b,d,v})=>bell(f,s+b*bt,d*bt,v*0.85));
  }

  const s0=angelEndCtx.currentTime+0.5;
  sched(s0); sched(s0+TB*bt);
  angelEndScheduled=s0+TB*bt*2;
  angelEndInterval=setInterval(()=>{
    if(!angelEndCtx)return;
    const n=angelEndCtx.currentTime;
    while(angelEndScheduled<n+3+TB*bt){sched(angelEndScheduled);angelEndScheduled+=TB*bt;}
  },500);
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
window.startMusic = startMusic;
window.handleAudioBtn = function() {
  document.getElementById('audio-btn').textContent='èª­ã¿è¾¼ã¿ä¸­...';
  startMusic();
};

})(); // IIFEçµ‚ã‚ã‚Š

</script>
